<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Feed</title>
    <style>
        table {
            height:100%;
            width:100%;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        * {
            margin: 0;
        }

        td {
            width: 50%;
        }

        video {
            position: absolute;
            z-index: 0;
            top: 0;
            min-width: 50%;
            max-width: 50%;
            min-height: 100%;
            width: auto;
            height: auto;
        }

        video#rightfeed {
            left: 50%;
        }

        video#leftfeed {
            left: 0;
        }
    </style>
</head>
<body>
<!--<table>-->
    <!--<tr>-->
        <!--<td></video></td>-->
        <!--<td>></td>-->
    <!--</tr>-->
<!--</table>-->

<table id="fullscreen">
    <tr style="height: 100%;">
        <td>
            <video id="leftfeed">
            </video>
        </td>
        <td><video id="rightfeed"></video></td>
    </tr>
</table>â€‹
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub-3.7.14.min.js"></script>
<script src="https://cdn.pubnub.com/webrtc/webrtc.js"></script>
<script src="https://cdn.pubnub.com/webrtc/rtc-controller.js"></script>
<script>
    // TODO: DO i need?

    function onIceCandidate(event) {
                if (event.candidate) {
                    var candidate = {
                        sdpMLineIndex: event.candidate.sdpMLineIndex,
                        sdpMid: event.candidate.sdpMid,
                        candidate: event.candidate.candidate
                    };
                    var request = {
                        what: "addIceCandidate",
                        data: JSON.stringify(candidate)
                    };
                    ws.send(JSON.stringify(request));
                } else {
                    console.log("End of candidates.");
                }
            }

                        function onDataChannel(event) {
                console.log("onDataChannel()");
                datachannel = event.channel;

                event.channel.onopen = function () {
                    console.log("Data Channel is open!");
                    document.getElementById('datachannels').disabled = false;
                };

                event.channel.onerror = function (error) {
                    console.error("Data Channel Error:", error);
                };

                event.channel.onmessage = function (event) {
                    console.log("Got Data Channel Message:", event.data);
                    document.getElementById('datareceived').value = event.data;
                };

                event.channel.onclose = function () {
                    datachannel = null;
                    document.getElementById('datachannels').disabled = true;
                    console.log("The Data Channel is Closed");
                };
            }






    const ADDRESS = '10.4.180.77';
    const PORT = '8080';


    var leftVideo = document.getElementById('leftfeed');
    var rightVideo = document.getElementById('rightfeed');

    var stream;

    var signalling_server_hostname = ADDRESS;
    var signalling_server_fqdn = ADDRESS + ':' + PORT;

    RTCPeerConnection = window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    RTCSessionDescription = window.mozRTCSessionDescription || window.RTCSessionDescription;
    RTCIceCandidate = window.mozRTCIceCandidate || window.RTCIceCandidate;
    navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia || navigator.msGetUserMedia;
    var URL = window.URL || window.webkitURL;

    var pcConfig = {"iceServers": [
                    {"urls": ["stun:stun.l.google.com:19302", "stun:" + signalling_server_hostname + ":3478"]}
                ]};
    var pcOptions = {
        optional: [
            // Deprecated:
            //{RtpDataChannels: false},
            //{DtlsSrtpKeyAgreement: true}
        ]
    };

    function onRemoteStreamAdded(event) {
          console.log("Remote stream added:", URL.createObjectURL(event.stream));

          leftVideo.src = URL.createObjectURL(event.stream);

          if (leftVideo.captureStream) {
            stream = leftVideo.captureStream();
            rightVideo.srcObject = stream; // Set right video to left
            console.log('Captured stream from leftVideo with captureStream', stream);
          }
          else if (leftVideo.mozCaptureStream) {
            stream = leftVideo.mozCaptureStream();
            rightVideo.srcObject = stream;
            console.log('Captured stream from leftVideo with mozCaptureStream()', stream);
          } else {
            console.log('captureStream() not supported');
          }
          leftVideo.play();
    }

    function onRemoteStreamRemoved() {
        leftVideo.src = '';
    }


    function createPeerConnection(){
      console.log("CREATE PEER Connection");
      pc = new RTCPeerConnection(pcConfig, pcOptions);
      pc.onaddstream = onRemoteStreamAdded;
      pc.onremovestream = onRemoteStreamRemoved;
      pc.onDataChannel = onDataChannel;
      pc.onIceCandidate = onIceCandidate;

      console.log("peer connection successfully created!");
    }


//    leftVideo.oncanplay = maybeCreateStream;

//    if (leftVideo.readyState >= 3) {  // HAVE_FUTURE_DATA
//      // Video is already ready to play, call maybeCreateStream in case oncanplay
//      // fired before we registered the event handler.
//      maybeCreateStream();
//    }
//


    function start() {
      if ("WebSocket" in window) {
        server = signalling_server_fqdn;
        var protocol = ["https:", "file:"].indexOf(location.protocol) > 0 ? "wss:" : "ws:";

        ws = new WebSocket(protocol + '//' + server + '/stream/webrtc');

        function call(stream) {
          createPeerConnection();
          if (stream) {
            console.log("STREAM!!", stream);
            pc.addStream(stream);
          }
          else {console.log("No Stream :(")}
          var request = {
            what: "call",
            options: {
              force_hw_vcodec: false,
              vformat: 60 // TODO: Dont hardcode format
            }
          };
          ws.send(JSON.stringify(request));
          console.log("call(), request=" + JSON.stringify(request));
        }


        ws.onopen = function () {
          console.log("onopen()");

          audio_video_stream = null;
          var cast_mic = false;
          var cast_tab = false;
          var cast_camera = false;
          var cast_screen = false;
          var cast_window = false;
          var cast_application = false;
          var echo_cancellation = false;
          var localConstraints = {};
          if (cast_mic) {
            if (echo_cancellation) {
              localConstraints['audio'] = isFirefox ? {echoCancellation: true} : {optional: [{echoCancellation: true}]};
            }
            else
              localConstraints['audio'] = isFirefox ? {echoCancellation: false} : {optional: [{echoCancellation: false}]};
          } else if (cast_tab) {
            localConstraints['audio'] = {mediaSource: "audioCapture"};
          } else {
            localConstraints['audio'] = false;
          }
          if (cast_camera) {
            localConstraints['video'] = true;
          } else if (cast_screen) {
            if (isFirefox) {
              localConstraints['video'] = {
                frameRate: {ideal: 15, max: 30},
                //width: {min: 640, max: 960},
                //height: {min: 480, max: 720},
                mozMediaSource: "screen",
                mediaSource: "screen"
              };
            } else {
              // chrome://flags#enable-usermedia-screen-capturing
              document.getElementById("cast_mic").checked = false;
              localConstraints['audio'] = false; // mandatory for chrome
              localConstraints['video'] = {'mandatory': {'chromeMediaSource': 'screen'}};
            }
          } else if (cast_window)
            localConstraints['video'] = {
              frameRate: {ideal: 15, max: 30},
              //width: {min: 640, max: 960},
              //height: {min: 480, max: 720},
              mozMediaSource: "window",
              mediaSource: "window"
            };
          else if (cast_application)
            localConstraints['video'] = {
              frameRate: {ideal: 15, max: 30},
              //width: {min: 640, max: 960},
              //height:  {min: 480, max: 720},
              mozMediaSource: "application",
              mediaSource: "application"
            };
          else
            localConstraints['video'] = false;

          var localVideoElement = document.getElementById('local-video');
          if (localConstraints.audio || localConstraints.video) {
            if (navigator.getUserMedia) {
              navigator.getUserMedia(localConstraints, function (stream) {
                audio_video_stream = stream;
                call(stream);
                localVideoElement.muted = true;
                localVideoElement.src = URL.createObjectURL(stream);
                localVideoElement.play();
              }, function (error) {
                stop();
                alert("An error has occurred. Check media device, permissions on media and origin.");
                console.error(error);
              });
            } else {
              console.log("getUserMedia not supported");
            }
          } else {
            call();
          }
        };

      }

    }












      function fullscreen() {
                var remoteVideo = document.getElementById("fullscreen");
                if (remoteVideo.requestFullScreen) {
                    remoteVideo.requestFullScreen();
                } else if (remoteVideo.webkitRequestFullScreen) {
                    remoteVideo.webkitRequestFullScreen();
                } else if (remoteVideo.mozRequestFullScreen) {
                    remoteVideo.mozRequestFullScreen();
                }
            }





    window.onload = function() {
      start();
    };

    window.onunload = function() {
      stop();
    };
</script>

</body>
</html>